# Chapter8. 교착 상태
## 교착상태 특성
- 필요조건
  - 상호 배제(mutual exclusion) : 최소한 하나의 자원이 비공유 모드로 점유. 다른 스레드가 자원 요청 시, 요청 스레드는 자원이 방출될 때 까지 대기
  - 점유하며 대기(hold-and-wait) : 스레드는 최소한 하나의 자원을 점유한 채, 현재 다른 스레드에 의해 점유된 자원을 추가로 얻기 위해 반드시 대기
  - 비선점(no preemption) : 자원 선점 불가능. 점유하고 있는 스레드가 태스크 종료 후 자발적 방출만 가능.
  - 순환 대기(circular wait) : 스레드들이 순환적으로 점유한 자원을 대기.

- 자원 할당 그래프
  ![image](https://github.com/YunYongWoon/CS-STUDY/assets/46861704/65f48716-4254-49e5-b87b-35a6d9a67108)
  - 자원 할당 그래프에 사이클이 없으면 교착상태가 아니다.
  - 사이클이 있으면, 교착상태일수도 있고 아닐수도 있다.

## 교착상태 처리 방법
- 문제를 무시하고, 교착상태가 발생하지 않은 척 한다. (Window, linux)
- 시스템이 교착상태가 되지 않도록 보장하기 위해 예방, 혹은 회피하는 프로토콜 사용
- 교착상태를 허용 후 복구(DB 등)

## 교착 상태 예방
- 교착상태가 발생하는 4가지 필요조건 중 최소한 하나가 성립하지 않도록 보장
### 상호 배제
- 모든 자원을 공유 허용한다.
- 현실적으로 불가능
### 점유하며 대기
- 필요한 자원을 한번에 모두 할당하는 방법. 실용적이지 않음.
- 대안으로 자원을 전혀 갖고 있지 않을때만 자원 요청 가능
  - 추가 자원을 요청하려면 우선 자신에게 할당된 모든 자원을 방출
- 자원의 낭비가 발생할 수 있다.
  - 자원이 필요하지 않을 때에도 선점할 가능성이 있음
- 기아 현상 발생 가능
### 비선점
- 프로세스가 할당 받을 수 없는 자원을 요청하면, 기존에 가지고 있던 자원을 모두 반납하고 작업을 취소
  - 이후 처음 혹은 체크포인트부터 다시 시작
- 자원 낭비 가능
### 순환 대기
- 자원에 순서를 부여하여, 프로세스가 순서에 따라 자원을 요청하도록 요구.

## 교착상태 회피 방법
- 자원이 어떻게 요청될 지에 대한 추가 정보를 제공하도록 요구함.
### Safe State
- safe하다는 말은 시스템이 어떤 순서로든 스레드들이 요청하는 모든 자원을 교착상태를 야기시기키 않고 차례로 할당 가능하다는 것을 뜻함.
- 반대로 unsafe 상태는 교착상태가 발생할 가능성이 있는 상태.
### 자원 할당 그래프 알고리즘
- 미래에 요청할 자원을 점선으로 연결. 이후 사이클 탐지 알고리즘을 사용하여 그래프에 사이클이 없으면 자원을 할당하는 방식.
### 은행원 알고리즘
- 스레드가 시작할 때 스레드가 가지고 있어야 할 자원의 최대 개수를 미리 신고(자원의 총 보유 수를 넘어서면 안됨)
- 스레드가 자원을 요청하면 시스템은 그것을 허가할 때 safe한지 체크

## 교착상태 탐지
- 현재 시스템에서 데드락을 감지한다.
- wait-for 그래프 사용
- Graph reduction
  - 자원할당 그래프에서 block되지 않은 태스크의 간선 제거를 반복
  - 간선이 남으면 데드락, 안남으면 safe
  - node가 많거나 주기에 따라 오버헤드 up

## 교착상태 회복
### 프로세스/스레드 종료
- 교착상태 프로세스 전부 중지
  - 오래 연산한 프로세스가 날아가는 경우가 발생하는 등의 비용이 발생
- 교착상태가 제거될 때 까지 한 프로세스씩 중지
  - 프로세스가 중지될 때마다 교착상태 탐지 알고리즘을 호출해야 하는 오버헤드 발생
- 우선순위, 남은 시간 등의 고려사항들 필요 
### 자원 선점
- 교착상태가 깨질때까지 프로세스로부터 자원을 선점해 다른 프로세스에게 전달.
- 고려사항
  - 희생자 선택 : 어느 자원과 어느 프로세스가 선점될 것인가?
    - 비용을 최소화 하기 위한 순서 필요.
  - 후퇴 : 자원이 선점된 프로세스는 어떻게 처리할 것인가?
    - 프로세스가 정상적으로 실행할 수 없으므로 안전한 상태로 후퇴시키고, 추후에 다시 시작
  - 기아 상태 : 기아 상태가 발생하지 않도록 보장하는 방법은?
    - 비용 요소에 후퇴 횟수 포함 등의 방법

> - DB의 데드락
> 1. 트랜잭션으로 수행되며, 주기적으로 Wait-for 그래프에서 사이클을 검색하여 트랜잭션 집합 내의 교착 상태 감시.
> 2. 교착 상태가 감지되면 희생양이 선택되고 트랜잭션이 롤백.
> 3. 나머지 트랜잭션이 재개되면 중단된 트랜잭션 다시 시작.