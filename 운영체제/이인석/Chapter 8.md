# Chapter 8. 교착 상태 (데드락)

- 두 개 이상의 테스크가 서로의 자원을 무한히 대기하는 상태

## 교착 상태 특성

### 필요 조건

교착 상태는 한 시스템에 네 가지 조건이 동시에 성립될 때 발생한다.

- Mutual Exclusion
    - 자원은 공유되지 않고, 한 번에 하나의 태스크만 사용 가능해야 한다.
- Hold and Wait
    - 태스크는 최소한 하나의 자원을 점유한 채, 다른 스레드의 의해 점유된 자원을 추가로 얻기 위해 반드시 대기해야 한다.
- No Preemption
    - 자원들을 선점할 수 없어야 한다.
- Circular Wait
    - 자원 요청 관계와 할당 관계가 원형을 이뤄야 한다.

## 교착 상태 처리 방법

### 원칙적인 방법

- 문제를 무시하고, 절대 발생하지 않은 척한다.
    - Linux와 Windows를 포함해 사용하는 방법으로 교착 상태 처리를 응용 개발자아게 맡긴다.
- 교착 상태가 되지 않도록 예방하거나 회피하는 프로토콜을 사용한다.
- 교착 상태가 되도록 허용한 다음 복구한다.

### 교착 상태 예방

교착 상태의 필요 조건 중 적어도 하나 이상을 성립하지 않도록 보장하는 방법

- Mutual Exclusion
    - 모든 자원을 공유한다 ( ex) 읽기 전용 파일로 전부 )
    - 어떤 자원들은 근본적으로 공유가 불가능하기 때문에 현실적으로 불가능한 방법( ex) mutex lock은 여러 스레드가 동시에 공유하는 것이 불가능 )
- Hold and Wait
    - 테스크가 자원을 요청할 때, 자원을 보유하지 않도록 보장
    - 실행을 시작하기 전에 모든 자원을 요청하고 할당
    - 필요하지 않은 순간에도 자원을 모두 할당하고 있으므로 낭비 발생
    - 필요한 자원이 많이 쓰인다면, 무한 대기가 발생할 수 있음
- No Preemption
    - 할당할 수 없는 다른 자원을 요청하면, 현재 점유하고 있는 모든 자원을 반납하고 작업 취소
        - 모든 자원을 선점했을 때, 처음 혹은 체크 포인트부터 다시 시작
    - 모든 자원에 대해 비선점 조건 해제 ⇒ 요청 후 대기
    - mutex lock이나 세마포와 같은 자원에는 적용할 수 없음
- Circular Wait
    - 모든 자원 할당에 순서를 부여
    - 동일 유형의 경우, 단 한 번의 자원 요청으로 모든 자원을 할당 받는다.

### 교착 상태 회피

모든 태스크와 자원의 상태를 알고 있는 상태에서 안전상태를 유지하는 방법

- 안전상태 : 모든 태스크를 정상적으로 종료할 수 있는 순서가 존재하는 상태
- 불안전 상태 : 데드락이 발생할 수 있는 상태
- 스레드가 요구하고 사용할 자원에 대해 부가적인 정보를 미리 제공할 것을 요구
- 자원 할당 그래프 알고리즘
    - 미래의 자원 요청을 점선으로 표기하고, 사이클을 형성하지 않는다면 할당
- 은행원 알고리즘
    - 잔여 자원에 따라 태스크 별로 할당 가능한 순서를 탐색
    - 안전성
        - 현재 가용 가능한 자원보다 적은 추가 요청량을 가지는 태스크 탐색
        - 완료되면 할당중인 자원을 가용 가능한 자원에 포함
        - 해당 순서로 모든 태스크가 종료되면 안전
    - 자원 요청
        - 가용 자원이 요청보다 크면 시스템 상태를 할당한 상태처럼 변경해보고, 바뀐 상태가 안전하다면 할당한다. 아니라면 원래 상태로 복구하고, 안전상태를 만족할 때까지 대기한다

### 교착 상태 탐지

교착 상태 예방이나 상태 방지 알고리즘을 사용하지 않는다면, 탐지 및 복구 알고리즘을 지원해야 한다.

- Graph Reduction
    - 자원 할당 그래프에서 블록되지 않은 태스크의 간선을 제거
    - 반복해서 간선을 제거하고 남아있는 간선이 있다면 데드락
    - 검사 주기에 따라서, Node의 갯수가 많은 경우 오버헤드가 발생함

### 교착 상태 회복

- 프로세스와 스레드의 종료
    - 교착 상태 프로세스를 모두 중지
        - ⇒ 부분 계산 결과들 폐기 ⇒ 전체 다시 연산
    - 교착 상태가 제거될 때까지 한 프로세스 중지
        - ⇒ 매번 중지마다 교착 상태 탐지 ⇒ 큰 오버헤드
- 자원 선점
    - 데드락이 해제될 때까지 자원을 선점하여 배분
- DB
    - 주기적으로 wait-for 그래프에서 데드락 탐지 ⇒ 트랜잭션 롤백 ⇒ 재개
